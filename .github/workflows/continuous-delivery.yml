# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                          CONTINUOUS DELIVERY                                 â•‘
# â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
# â•‘  Handles versioning, changelog, and releases with the following strategy:   â•‘
# â•‘                                                                              â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â•‘
# â•‘  â”‚ Trigger              â”‚ Pre-ID      â”‚ npm Tag   â”‚ Example                â”‚ â•‘
# â•‘  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â•‘
# â•‘  â”‚ PR {type}/* â†’ developâ”‚ {type}.N    â”‚ pr-N      â”‚ 1.2.3-feature.42.0     â”‚ â•‘
# â•‘  â”‚ PR develop â†’ next    â”‚ alpha       â”‚ alpha     â”‚ 1.2.3-alpha.0          â”‚ â•‘
# â•‘  â”‚ PR next â†’ main       â”‚ rc          â”‚ rc        â”‚ 1.2.3-rc.0             â”‚ â•‘
# â•‘  â”‚ develop (scheduled)  â”‚ canary      â”‚ canary    â”‚ 1.2.3-canary.0         â”‚ â•‘
# â•‘  â”‚ develop (manual)     â”‚ dev         â”‚ dev       â”‚ 1.2.3-dev.0            â”‚ â•‘
# â•‘  â”‚ next (push)          â”‚ beta        â”‚ beta      â”‚ 1.2.3-beta.0           â”‚ â•‘
# â•‘  â”‚ next (scheduled)     â”‚ next        â”‚ next      â”‚ 1.2.3-next.0           â”‚ â•‘
# â•‘  â”‚ main (push)          â”‚ rc          â”‚ rc        â”‚ 1.2.3-rc.0             â”‚ â•‘
# â•‘  â”‚ main (manual)        â”‚ (none)      â”‚ latest    â”‚ 1.2.3                  â”‚ â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Continuous Delivery

on:
  push:
    branches: [main, next]
    paths-ignore:
      - "**.md"
      - "docs/**"
  schedule:
    # Canary releases: Run at midnight UTC for develop branch
    - cron: "0 0 * * *"
    # Next releases: Run at 06:00 UTC for next branch
    - cron: "0 6 * * *"
  pull_request:
    types: [labeled]
    branches: [develop, next, main]
  workflow_dispatch:
    # Branch is selected via GitHub UI's branch selector
    # Only main, next, and develop branches produce valid releases

permissions: write-all

concurrency:
  group: >-
    cd-${{
      github.event_name == 'pull_request'
        && format('pr-{0}', github.event.pull_request.number)
        || github.event_name == 'schedule'
        && (github.event.schedule == '0 0 * * *' && 'develop-canary' || 'next-scheduled')
        || github.ref
    }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ”§ DETERMINE RELEASE CONFIGURATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  config:
    name: Configure Release
    runs-on: ubuntu-latest
    # Only run for:
    # - Push to main or next
    # - Scheduled runs (nightly alpha from develop)
    # - Manual dispatch
    # - PRs with 'release' label
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.label.name == 'release')

    outputs:
      ref: ${{ steps.config.outputs.ref }}
      preid: ${{ steps.config.outputs.preid }}
      dist_tag: ${{ steps.config.outputs.dist_tag }}
      prerelease: ${{ steps.config.outputs.prerelease }}

    steps:
      - name: Determine release configuration
        id: config
        run: |
          PRERELEASE="true"
          PREID=""
          DIST_TAG="latest"
          REF="${{ github.ref }}"

          case "${{ github.event_name }}" in
            push)
              if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
                # Push to main = RC release (stable is manual only!)
                PREID="rc"
                DIST_TAG="rc"
                echo "ğŸ“¦ Release Candidate from main (stable requires manual dispatch)"
              elif [[ "${{ github.ref }}" == "refs/heads/next" ]]; then
                PREID="beta"
                DIST_TAG="beta"
                echo "ğŸ“¦ Beta release from next"
              fi
              ;;
            schedule)
              # Determine which schedule triggered based on cron expression
              if [[ "${{ github.event.schedule }}" == "0 0 * * *" ]]; then
                # 00:00 UTC = develop â†’ canary
                REF="develop"
                PREID="canary"
                DIST_TAG="canary"
                echo "ğŸ“¦ Canary release from develop (scheduled)"
              else
                # 06:00 UTC = next â†’ next
                REF="next"
                PREID="next"
                DIST_TAG="next"
                echo "ğŸ“¦ Next release from next (scheduled)"
              fi
              ;;
            pull_request)
              REF="${{ github.event.pull_request.head.ref }}"
              PR_NUM="${{ github.event.pull_request.number }}"
              BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
              HEAD_BRANCH="${{ github.event.pull_request.head.ref }}"

              # Determine preid based on PR target branch
              case "$BASE_BRANCH" in
                main)
                  # PR next â†’ main = RC
                  PREID="rc"
                  DIST_TAG="rc"
                  echo "ğŸ“¦ Release Candidate: PR #$PR_NUM ($HEAD_BRANCH â†’ main)"
                  ;;
                next)
                  # PR develop â†’ next = Alpha
                  PREID="alpha"
                  DIST_TAG="alpha"
                  echo "ğŸ“¦ Alpha release: PR #$PR_NUM ($HEAD_BRANCH â†’ next)"
                  ;;
                develop)
                  # PR feature/* â†’ develop = extract branch type
                  if [[ "$HEAD_BRANCH" == */* ]]; then
                    # Extract prefix before first / (feature, hotfix, bugfix, etc.)
                    BRANCH_TYPE="${HEAD_BRANCH%%/*}"
                  else
                    # No prefix, use generic 'pr'
                    BRANCH_TYPE="pr"
                  fi
                  PREID="${BRANCH_TYPE}.${PR_NUM}"
                  DIST_TAG="pr-${PR_NUM}"
                  echo "ğŸ“¦ PR preview release: ${BRANCH_TYPE}.${PR_NUM} ($HEAD_BRANCH â†’ develop)"
                  ;;
              esac
              ;;
            workflow_dispatch)
              REF="${{ github.ref_name }}"
              case "$REF" in
                main)
                  # Manual main = STABLE release
                  PREID=""
                  DIST_TAG="latest"
                  PRERELEASE="false"
                  echo "ğŸ“¦ Stable release from main (manual)"
                  ;;
                next)
                  # Manual next = next (same as scheduled)
                  PREID="next"
                  DIST_TAG="next"
                  echo "ğŸ“¦ Next release from next (manual)"
                  ;;
                develop)
                  # Manual develop = dev (on-demand development build)
                  PREID="dev"
                  DIST_TAG="dev"
                  echo "ğŸ“¦ Dev release from develop (manual)"
                  ;;
                *)
                  echo "âŒ Invalid branch for manual release: $REF"
                  echo "   Only main, next, and develop branches can trigger releases."
                  exit 1
                  ;;
              esac
              ;;
          esac

          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "preid=$PREID" >> $GITHUB_OUTPUT
          echo "dist_tag=$DIST_TAG" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸš€ RELEASE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  release:
    name: Release
    needs: config
    uses: tsok-org/.github/.github/workflows/nx-cd.yml@main
    with:
      # Git configuration
      ref: ${{ needs.config.outputs.ref }}

      # Version configuration
      preid: ${{ needs.config.outputs.preid }}
      dist_tag: ${{ needs.config.outputs.dist_tag }}
      github_prerelease: ${{ needs.config.outputs.prerelease == 'true' }}

      # Publishing
      publish_docker: true
      docker_registry: ghcr.io
      docker_platforms: "linux/amd64,linux/arm64"

      # GitHub App for branch protection bypass
      github_app_id: ${{ vars.OPERATOR_GITHUB_APPLICATION_ID }}

    secrets:
      github_app_private_key: ${{ secrets.OPERATOR_GITHUB_APP_PRIVATE_KEY }}
      nx_cloud_access_token: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
